---
key: /2023/03/06/Week15-Day.html
title: TIL - 15주차 코드
tags: spring maven springboot RestfulAPI mariaDB SpringDI xml annotation mybatis yml HTTP
---

# 1. SpringBoot Mybatis : 230306

## 1) 이전 내용 복습 : 

<br>

### a. 리액티브 개념 : 

- 모델을 이용해서 View와 Controller로 나눈 것으로 MVC 패턴의 다른말이다.

<br><br>

### b. 리액티브 플랫폼 :

- react, angular, vue.js가 있다. model을 view가 소비한다. 

- 컨트롤러 개입 없이 model이 view를 바꾸고 view가 model을바꾸는 개념이 리액티브 개념이다. 그래서 re-active이다. 

<br><br>

### c. Jaesper :

- 기존 코드를 서블릿 코드로 만들어주는 도구이다.

<br><br>

### d. JSTL과 EL을 이용한 View의 코드

- 태그 라이브러리란?
	- 태그 모양으로 행위를 가지는 라이브러리

<br>
- 사용 용도 	
	- View 단에서 자바 코드를 드러내기 위해 사용한다.
	- 분업화를 위해서 자바 코드가 사용되면 단순한 제어를 위해 자바를 잘 아는 사람이 참여해야 하는 것이 비효율적이기도 하고 수 많은 코드 블록의 삽입이 코드를 복잡하고 유지보수하기에 힘든 문제가 있어서

<br>
- JSTL 제어를 위해 사용하는 데이터는 어디에 저장된 데이터인가? 지역변수인가?
	- 서버 4대저장소(page, request, session, application)
<br>
- EL을 이용할 때의 장점은 무엇인가?
	- 자바 코드 없이 4대 저장소의 값을 쉽고 간결하게 꺼내올 수 있다.

<br>
- 데이터를 저장하기 위해서 지역변수가 아닌 4대 저장소를 활용하는 이유?**
	- 출력데이터는 기본 지역 데이터와 분리해서 사용할 필요가 있다. MVC는 코드를 나누는 방식을 사용하기 때문에 View의 데이터는 최소 다른 서블릿과 데이터를 공유하는 것이 기본이다. 뿐만 아니라 단일한 데이터 소비를 위해서라도 지역변수를 범주에 두는 것은 전체 변수 사용에 충돌이나 복잡한 문제를 가질 수 있다.

<br><br>

### e. 쿠키 

- 쿠키에는 빈공백이나 특수문자 등은 들어갈 수 없어요. 따라서 URL 방식으로 인코딩될 수 있는 문자열만 가능합니다. URL에 사용할 수 있는 형태로만 저장이 가능하다고 보면 된다.

- 클라이언트 환경이 너무 다양하기 때문에 그것을 신뢰해서 사용하기는 힘들 수도 있습니다. 필수 데이터를 위해서 사용하기 보다는 부가적으로 필요한 데이터로 사용하는 것이 좋을 것 같습니다. 예를 들어서 그 데이터 없이 페이지를 만들 수 없다거나 그것이 아니라 사용할 수 없음 말고 식으로 가볍게 사용할 데이터여야 합니다.(세선 ID, 인증 관련 토큰 등**)



---

<br><br>

## 2) Mybatis

<br>

### a. 실습 코드 : 

- MenuRepository.java

```java
package kr.co.rland.web.repository;

import java.util.List;

import org.apache.ibatis.annotations.Mapper;
import org.apache.ibatis.annotations.Select;

import kr.co.rland.web.entity.Menu;

// @Repository
// ibatis가 원래 이름인데 버전이 업되면서 mybatis로 바뀌었다. mapper로 매핑
// @Mapper가 구현체를 알아서 repository에 붙여준다.
// 하지만, 이렇게 되면 
@Mapper
public interface MenuRepository {
	
	// SQL문은 모든 메서드 중에서 쓸 거만 구현해도 된다.
	@Select("select * from menu")
	List<Menu> findAll();
	
	Menu findById(long id);
	
	Menu insert(Menu menu);
	
	Menu update(Menu menu);
	
	void delete(long id);
}

```

<br>

### b. Mybatis 사용 방법 :  

- SQL문에 데이터 대입할 때, id가 문자열 타입이면 #을 쓰면 ""가 포함되고 $를 쓰면 ""가 포함되지 않고 값을 그대로 쓴다.(정수와 문자열을 비교)


<br>

### c. Mybatis 문제점 :  

- SQL문에 내려쓰기가 불가능하다. 복잡하게 SQL문을 "+"로 이어줘야 한다.
- 또한, 인터페이스에 어노테이션을 붙여서 문제가 많다.
- SQL문이 길어지면 길어질수록 가독성이 안 좋아진다. 원래, 인터페이스가 무엇인지 알아보기 힘들다. 


```java

package kr.co.rland.web.repository;

import java.util.List;

import org.apache.ibatis.annotations.Mapper;
import org.apache.ibatis.annotations.Select;

import kr.co.rland.web.entity.Menu;

// @Repository
// ibatis가 원래 이름인데 버전이 업되면서 mybatis로 바뀌었다. mapper로 매핑
// @Mapper가 구현체를 알아서 repository에 붙여준다.
// 하지만, 이렇게 되면 
@Mapper
public interface MenuRepository {
	
	// SQL문은 모든 메서드 중에서 쓸 거만 구현해도 된다.
	@Select("select * from menu")
	List<Menu> findAll();
	@Select("select * from menu where id=#{id}")
	Menu findById(long id);
	
	Menu insert(Menu menu);
	
	Menu update(Menu menu);
	
	void delete(long id);
}

```

---

<br>
#### d. 해결 방법 : 
- @Mapper만 남기고 SQL문에 해당하는 어노테이션은 다 지우자! 그래서, resources 폴더에 Mapper 폴더를 만들고 xml 파일을 만들자. 또한, Entity 폴더로 갈 수도 있다.
- 그래서, 다이나믹 프로그래밍을 하자.

<br>
#### e. 해결 과정 : 

<br>
##### 1) XML 파일에 [Mybatis 초기 설정 구문 참고 사이트](https://mybatis.org/mybatis-3/getting-started.html#exploring-mapped-sql-statements)에 들어가서 Exploring Mapped SQL Statements 부분을 추가해주자
	
```xml
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.mybatis.example.BlogMapper">
  <select id="selectBlog" resultType="Blog">
    select * from Blog where id = #{id}
  </select>
</mapper>
```

<br>
##### 2) XML 파일에 SQL문 매핑에 관한 실습 코드 

```java
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.co.rland.web.repository.MenuRepository">
	<select id="findAll" resultType="kr.co.rland.web.entity.Menu">
		select * from menu
	</select>
	
	<select id="findById" resultType="kr.co.rland.web.entity.Menu">
		select * from menu where id=#{id}
	</select>
	
<!-- 	<insert id="insert">
	
	</insert>
	
	<update id="update">
	
	</update>
	
	
	<delete id="delete">
	</delete> -->
</mapper>
```
	
<br>
	
##### 3) 추가 설정

- 우리는 이제 내가 이 SQL문을 매핑했다고 Mybatis에게 알려줘야 한다.	

<br>	
- 원래, application.properties가 root 설정이다. 그래서, 모든 페이지에서 쓰이는 공통적인 부분만 설정해준다.

- 그래서 우리는 application-dev.yml(application-prod.yml)로 설정할 것인지 application.properties로 설정할 것인지 판단하여 프로필 설정만 해준다.
	- 둘 중 하나만 설정하므로 application-dev.yml에서 설정하고 application.properties의 DB 연결 설정을 모두 지우자.

- application.properties

```properties

spring.servlet.multipart.max-file-size=100MB	
#각각의 파일 용량 
spring.servlet.multipart.max-request-size=200MB 
#전체 용량

```

- application-dev.yml

```yml

spring:
  datasource:
    url: jdbc:mariadb://db.newlecture.com:3306/rlanddb
    driver-class-name: org.mariadb.jdbc.Driver
    username: rland
    password: 20220823
    
```

<br>
	
##### 4) yml에 classpath 설정하기

- 해당 경로에서 xml을 사용하기 위해서 ClassPathXmlApplicationContext을 설정을 해주고 설정을 따로 안해주면 root 경로가 기본이라서 root를 기준으로 xml 파일을 찾아서 읽는다.
- 추가로 Maven 프로젝트는 Java 폴더가 root 경로이다.
- 그래서, xml 파일에서 SQL문의 반환 타입을 설정해주기 위해서 resultType 속성의 경로를 `/rlandboot3/src/main/java/kr/co/rland/web/entity/Menu.java`에서 java부터 시작 경로를 설정해준다.
	- 그래서, `kr.co.rland.web.entity.Menu`로 설정해준다.
	
<br>	
- 그리고 yml 설정 파일에서 모든 클래스를 매핑하려고 마이바티스 설정의  mapper-location 속성을 `*Mapper.xml`라고 설정하면 Mapper로 끝나는 모든 파일에 대하여 매핑이 가능하다. 
	- 추가로 `.yml`파일은 모두 빈 공백도 약속이라서 매우 주의해서 사용하자! 

- application.yml
	
```yml

spring:
  profiles:
    active:
    - dev

mybatis:
  mapper-location:
  - classpath:mapper/*Mapper.xml
```


<br>
	
##### 5) Mybatis SQL문의 반환 타입인 resultType 설정 

- Mybatis에서 xml 설정에서 SQL문을 실행 후 반환할때, Entity를 담는 그릇도 경로 설정도 resultType으로 해주어야 한다.

- 경로는 Copy Qualified Name에서 가져오고 경로에서 절대경로인 슬래쉬 "/"는 모두 지운다.


```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.co.rland.web.repository.MenuRepository">
	<select id="findAll" resultType="kr.co.rland.web.entity.Menu">
		select * from menu
	</select>
	
	<select id="findById" resultType="kr.co.rland.web.entity.Menu">
		select * from menu where id=#{id}
	</select>

<!-- 	<insert id="insert">
	
	</insert>
	
	<update id="update">
	
	</update>
	
	
	<delete id="delete">
	</delete> -->
</mapper>
```





